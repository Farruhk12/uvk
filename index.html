<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∫ –æ—Ç—á—ë—Ç–∞–º</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#1e293b; --muted:#6b7280;
    --accent:#e9413a; --accent-dark:#d7342d;
    --ok:#16a34a; --ok-btn:#16a34a; --ok-btn-shadow:rgba(22,163,74,.35);
    --border:#e5e7eb; --shadow:0 10px 22px rgba(15,23,42,.08);
    --shadow-sm:0 6px 14px rgba(15,23,42,.06);
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
  .container{max-width:980px;margin:0 auto;padding:20px 14px}
  h1{display:flex;gap:10px;align-items:center;font-size:28px;margin:0 0 12px}
  h1::before{content:"üì∏";}
  .panel{background:var(--card);border-radius:22px;box-shadow:var(--shadow);padding:18px;margin:14px 0}
  .filters{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  label{font-size:15px;color:var(--muted);display:block;margin-bottom:6px}
  select{width:100%;height:52px;border:1px solid var(--border);border-radius:16px;padding:10px 14px;font-size:16px;background:#fff}
  .big-btn{margin-top:14px;width:100%;height:56px;border:0;border-radius:16px;background:var(--accent);color:#fff;font-weight:700;font-size:18px;cursor:pointer;box-shadow:0 10px 20px rgba(233,65,58,.25)}
  .big-btn:active{transform:translateY(1px);background:var(--accent-dark)}

  .doctor{background:var(--card);border-radius:22px;box-shadow:var(--shadow-sm);padding:14px 16px;margin:14px 0}
  .doc-top{display:flex;gap:12px;align-items:center}
  .doc-name{font-weight:800;font-size:18px;flex:1;min-width:180px}

  .success{display:flex;align-items:center;gap:12px;color:var(--ok);font-weight:700;white-space:nowrap}

  .controls-inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;white-space:nowrap}
  .file-name{max-width:300px;color:#b91c1c;font-weight:600;overflow:hidden;text-overflow:ellipsis}
  .btn-upload{
    height:44px; padding:0 16px; border:0; border-radius:14px; background:var(--accent); color:#fff;
    font-weight:800; cursor:pointer; box-shadow:0 8px 16px rgba(233,65,58,.25)
  }
  .btn-gray{
    height:44px; padding:0 16px; border:2px dashed var(--border); border-radius:14px; background:#fafafa; color:#6b7280; font-weight:700; cursor:pointer;
  }
  .btn-danger{
    height:40px; padding:0 14px; border:0; border-radius:12px; background:#fee2e2; color:#b91c1c; font-weight:800; cursor:pointer;
  }
  .btn-upload:active{transform:translateY(1px);background:var(--accent-dark)}
  .btn-danger:disabled{opacity:.6;cursor:not-allowed}

  @media (max-width:720px){
    .filters{grid-template-columns:1fr}
    .doc-top{flex-direction:column; align-items:flex-start}
    .controls-inline{justify-content:flex-start}
    .file-name{max-width:100%}
  }

  /* –∫—Ä–æ—à–µ—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ */
  .reset-link{margin-top:8px;font-size:13px;color:#6b7280;cursor:pointer;text-decoration:underline}
</style>
</head>
<body>
  <div class="container">
    <h1>–û—Ç—á–µ—Ç –£–í–ö</h1>

    <div class="panel">
      <div class="filters">
        <div><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label><select id="nameSel"></select></div>
        <div><label>–ú–µ—Å—è—Ü</label><select id="monthSel"></select></div>
      </div>
      <button class="big-btn" id="showBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
      <div class="reset-link" id="resetChoice" style="display:none">–°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤—ã–±–æ—Ä</div>
    </div>

    <div class="panel" id="list">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫¬ª</div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzkZl9EYJSIndXxUeK5P6IzIMpmre8nkwUtyl3L3KQNusJk9hGM-ij7kvU0j1Crr_BX/exec';

// –∫–ª—é—á–∏ –¥–ª—è localStorage
const LS_KEYS = {
  name:  'lf_name',
  month: 'lf_month'
};

const nameSel = document.getElementById('nameSel');
const monthSel = document.getElementById('monthSel');
const showBtn  = document.getElementById('showBtn');
const listDiv  = document.getElementById('list');
const resetLink = document.getElementById('resetChoice');

async function loadMeta(){
  nameSel.innerHTML = monthSel.innerHTML = '<option selected disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
  try{
    const r = await fetch(`${WEB_APP_URL}?fn=meta`);
    const {names, months} = await r.json();
    fillSelect(nameSel, names);
    fillSelect(monthSel, months);

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤—ã–±–æ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–∞—Ö
    restoreSavedChoice(names, months);

    toggleShowBtn();
  }catch{
    nameSel.innerHTML = monthSel.innerHTML = '<option>–û—à–∏–±–∫–∞</option>';
  }
}

function fillSelect(sel, arr){
  sel.innerHTML = '<option disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' +
    arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
}

[nameSel,monthSel].forEach(el=>el.addEventListener('change', ()=>{
  toggleShowBtn();
  saveChoice();                // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
}));

function toggleShowBtn(){ showBtn.disabled = !(nameSel.value && monthSel.value); }

showBtn.addEventListener('click', async ()=>{
  // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—â—ë —Ä–∞–∑ —Å–æ—Ö—Ä–∞–Ω–∏–º
  saveChoice();

  listDiv.innerHTML = '–ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö...';
  try{
    const url = `${WEB_APP_URL}?fn=doctors&name=${encodeURIComponent(nameSel.value)}&month=${encodeURIComponent(monthSel.value)}`;
    const rows = await (await fetch(url)).json();
    renderRows(rows);
  }catch(e){ listDiv.textContent = '–û—à–∏–±–∫–∞: ' + e.message; }
});

// ======== —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ========
function saveChoice(){
  try{
    if (nameSel.value)  localStorage.setItem(LS_KEYS.name,  nameSel.value);
    if (monthSel.value) localStorage.setItem(LS_KEYS.month, monthSel.value);
    resetLink.style.display = (nameSel.value || monthSel.value) ? 'block' : 'none';
  }catch(_e){}
}

function restoreSavedChoice(names, months){
  try{
    const savedName  = localStorage.getItem(LS_KEYS.name);
    const savedMonth = localStorage.getItem(LS_KEYS.month);

    // –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Å–ø–∏—Å–∫–∞—Ö
    if (savedName && names.includes(savedName)) {
      nameSel.value = savedName;
    }
    if (savedMonth && months.includes(savedMonth)) {
      monthSel.value = savedMonth;
    }

    // –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ ‚Äî –ø–æ–∫–∞–∂–µ–º —Å—Å—ã–ª–∫—É "—Å–±—Ä–æ—Å–∏—Ç—å"
    resetLink.style.display = (nameSel.value || monthSel.value) ? 'block' : 'none';
  }catch(_e){}
}

// —Ä—É—á–Ω–æ–π —Å–±—Ä–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
resetLink.addEventListener('click', ()=>{
  try{
    localStorage.removeItem(LS_KEYS.name);
    localStorage.removeItem(LS_KEYS.month);
  }catch(_e){}
  nameSel.selectedIndex = 0;
  monthSel.selectedIndex = 0;
  toggleShowBtn();
  resetLink.style.display = 'none';
  listDiv.innerHTML = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫¬ª';
});

// ======== –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ –ª–æ–≥–∏–∫–µ ========
function renderRows(rows){
  if(!rows.length){ listDiv.innerHTML = '<div>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>'; return; }
  listDiv.innerHTML = rows.map(r=>{
    const doc = escapeHtml(r.doctor);
    if(r.link){
      return `
        <div class="doctor">
          <div class="doc-top">
            <div class="doc-name">${doc}</div>
            <div class="controls-inline">
              <span class="success">–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</span>
              <button class="btn-danger" onclick="delPhoto(${r.row}, '${escapeForJs(doc)}')">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
            </div>
          </div>
        </div>`;
    }
    return `
      <div class="doctor">
        <div class="doc-top">
          <div class="doc-name">${doc}</div>
          <div class="controls-inline">
            <!-- –±–µ–∑ capture: –±—É–¥–µ—Ç –≤—ã–±–æ—Ä –∫–∞–º–µ—Ä–∞/–≥–∞–ª–µ—Ä–µ—è -->
            <input type="file" accept="image/*" id="f_${r.row}" style="display:none" onchange="showFileName(${r.row})">
            <button class="btn-gray" onclick="choose(${r.row})">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <span id="fileName_${r.row}" class="file-name" style="display:none"></span>
            <button class="btn-upload" id="btn_${r.row}" onclick="upload(${r.row}, '${escapeForJs(doc)}')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

window.choose = (row)=>document.getElementById('f_'+row).click();
window.showFileName = (row)=>{
  const input = document.getElementById(`f_${row}`);
  const span  = document.getElementById(`fileName_${r.row}`);
  if(input.files && input.files[0]){ span.textContent = '–í—ã–±—Ä–∞–Ω: ' + input.files[0].name; span.style.display = 'inline'; }
};

const MAX_MB = 12;
window.upload = async function(row, doctor){
  const input = document.getElementById(`f_${row}`);
  const btn   = document.getElementById(`btn_${row}`);
  if(!input.files || !input.files[0]){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }

  const file = input.files[0];
  if(file.size > MAX_MB*1024*1024){ alert('–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª'); return; }

  btn.disabled = true;
  const originalText = btn.textContent;
  const t0 = Date.now();
  const timer = setInterval(()=>{
    const s = ((Date.now()-t0)/1000).toFixed(1);
    btn.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶ ${s}—Å`;
  }, 200);

  const base64 = await fileToBase64(file);
  const stamp = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
  const suggested = `${stamp} ‚Äî ${nameSel.value} ‚Äî ${monthSel.value} ‚Äî ${doctor}.${file.name.split('.').pop()}`;

  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'upload',
        payload:{
          row,
          filename:file.name,
          mimeType:file.type || 'image/jpeg',
          bytes:base64,
          suggestedName:suggested
        }
      })
    });
    await pollUntilLinked(row, 10000, 1000);
  }finally{
    clearInterval(timer);
    btn.disabled = false;
    btn.textContent = originalText;
  }
};

window.delPhoto = async function(row){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ?')) return;
  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        action:'delete',
        payload:{ row }
      })
    });
    await pollUntilUnlinked(row, 10000, 1000);
  }catch(e){
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + e.message);
  }finally{
    renderRows(await fetchDoctors());
  }
};

async function pollUntilLinked(row, timeout=10000, interval=1000){
  const start = Date.now();
  while(Date.now() - start < timeout){
    const rs = await fetchDoctors();
    const ok = rs.find(x => Number(x.row) === Number(row) && x.link);
    if(ok){ renderRows(rs); return; }
    await new Promise(r => setTimeout(r, interval));
  }
  renderRows(await fetchDoctors());
}

async function pollUntilUnlinked(row, timeout=10000, interval=1000){
  const start = Date.now();
  while(Date.now() - start < timeout){
    const rs = await fetchDoctors();
    const gone = rs.find(x => Number(x.row) === Number(row) && !x.link);
    if(gone){ renderRows(rs); return; }
    await new Promise(r => setTimeout(r, interval));
  }
  renderRows(await fetchDoctors());
}

async function fetchDoctors(){
  const url = `${WEB_APP_URL}?fn=doctors&name=${encodeURIComponent(nameSel.value)}&month=${encodeURIComponent(monthSel.value)}`;
  const res = await fetch(url);
  return res.json();
}

function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = e => resolve(String(e.target.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeForJs(s){ return s.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/'/g,"\\'"); }

loadMeta();
</script>
</body>
</html>
