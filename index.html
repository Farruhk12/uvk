<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –∫ –æ—Ç—á—ë—Ç–∞–º</title>
<style>
  /* –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–≤–æ–∏ —Å—Ç–∏–ª–∏ –∏–∑ –≤–µ—Ä—Å–∏–∏ —Å –∫—Ä–∞—Å–∏–≤—ã–º UI */
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f8fafc; color:#1e293b}
  .container{max-width:720px; margin:0 auto; padding:16px}
  .card{background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); padding:16px; margin:12px 0}
  .row{display:flex; gap:12px}
  .row>*{flex:1}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:8px; border:0; cursor:pointer; background:#ef4444; color:#fff}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  select, input{width:100%; height:44px; border:1px solid #e2e8f0; border-radius:8px; padding:8px 10px}
  .doctor{border-top:1px solid #e5e7eb; padding:16px 0}
  .file-wrap{border:2px dashed #e2e8f0; border-radius:10px; padding:12px; text-align:center; cursor:pointer}
  .ok{color:#10b981}
</style>
</head>
<body>
<div class="container">
  <h1>üì∏ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select id="nameSel"></select>
      </div>
      <div>
        <label>–ú–µ—Å—è—Ü</label>
        <select id="monthSel"></select>
      </div>
    </div>
    <div style="margin-top:12px">
      <button class="btn" id="showBtn" disabled>–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>
  </div>

  <div class="card" id="list">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫¬ª</div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzIX1AzaHXqUA5weBfDAaJd9RSsxj6cuvWI1NAUcpDxHlm8es8EOPbtLPbvNhwdXTGu/exec'; // –ø—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/AKfyc.../exec

const nameSel = document.getElementById('nameSel');
const monthSel = document.getElementById('monthSel');
const showBtn  = document.getElementById('showBtn');
const listDiv  = document.getElementById('list');

// 1) –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω—ã—Ö (—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏/–º–µ—Å—è—Ü—ã)
async function loadMeta() {
  nameSel.innerHTML  = '<option value="" selected disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
  monthSel.innerHTML = '<option value="" selected disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
  try {
    const res = await fetch(`${WEB_APP_URL}?fn=meta`);
    const {names, months} = await res.json();
    fillSelect(nameSel, names);
    fillSelect(monthSel, months);
    toggleShowBtn();
  } catch (e) {
    nameSel.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
    monthSel.innerHTML = '<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}
function fillSelect(sel, arr) {
  sel.innerHTML = '<option value="" disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' +
    arr.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
}
[nameSel, monthSel].forEach(el => el.addEventListener('change', toggleShowBtn));
function toggleShowBtn(){ showBtn.disabled = !(nameSel.value && monthSel.value); }

// 2) –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
showBtn.addEventListener('click', async () => {
  listDiv.innerHTML = '–ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö...';
  try {
    const url = `${WEB_APP_URL}?fn=doctors&name=${encodeURIComponent(nameSel.value)}&month=${encodeURIComponent(monthSel.value)}`;
    const rows = await (await fetch(url)).json();
    renderRows(rows);
  } catch (e) {
    listDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message;
  }
});

function renderRows(rows){
  if (!rows.length){
    listDiv.innerHTML = '<div>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</div>';
    return;
  }
  listDiv.innerHTML = rows.map(r => {
    const safeDoctor = escapeHtml(r.doctor);
    if (r.link){
      return `
        <div class="doctor">
          <div style="font-weight:600">${safeDoctor}</div>
          <div class="ok">–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ‚Äî <a href="${r.link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></div>
        </div>`;
    }
    return `
      <div class="doctor">
        <div style="font-weight:600">${safeDoctor}</div>
        <label class="file-wrap" onclick="document.getElementById('f_${r.row}').click()">
          –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
          <input type="file" accept="image/*" id="f_${r.row}" style="display:none" onchange="showFileName(${r.row})">
        </label>
        <div id="fileName_${r.row}" style="display:none; margin:6px 0; color:#ef4444"></div>
        <button class="btn" id="btn_${r.row}" onclick="upload(${r.row}, '${escapeForJs(safeDoctor)}')">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
      </div>`;
  }).join('');
}

window.showFileName = function(row){
  const input = document.getElementById(`f_${row}`);
  const div   = document.getElementById(`fileName_${row}`);
  if (input.files && input.files[0]) {
    div.textContent = '–í—ã–±—Ä–∞–Ω: ' + input.files[0].name;
    div.style.display = 'block';
  }
};

// 3) –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (POST JSON ‚Üí doPost)
window.upload = async function(row, doctor){
  const input = document.getElementById(`f_${row}`);
  const btn   = document.getElementById(`btn_${row}`);
  if (!input.files || !input.files[0]) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }

  const file = input.files[0];
  btn.disabled = true; const old = btn.textContent; btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

  const base64 = await fileToBase64(file); // –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ data:
  const stamp = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
  const suggested = `${stamp} ‚Äî ${nameSel.value} ‚Äî ${monthSel.value} ‚Äî ${doctor}.${file.name.split('.').pop()}`;

  try{
    // –í–ê–ñ–ù–û: no-cors –∏ –Ω–µ —á–∏—Ç–∞–µ–º res.json()
    await fetch(WEB_APP_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'upload',
        payload: {
          row,
          filename: file.name,
          mimeType: file.type || 'image/jpeg',
          bytes: base64,
          suggestedName: suggested
        }
      })
    });

    // –î–∞–¥–∏–º —Å–∫—Ä–∏–ø—Ç—É —Å–µ–∫—É–Ω–¥—É —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∏ –∑–∞–ø–∏—Å–∞—Ç—å —Å—Å—ã–ª–∫—É
    setTimeout(refreshDoctors, 1200);

  } catch (e){
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = old;
  }
};


async function refreshDoctors(){
  const url = `${WEB_APP_URL}?fn=doctors&name=${encodeURIComponent(nameSel.value)}&month=${encodeURIComponent(monthSel.value)}`;
  const rows = await (await fetch(url)).json();
  renderRows(rows);
}

function fileToBase64(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(String(e.target.result).split(',')[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeForJs(s){ return s.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/'/g,"\\'"); }

// –ó–∞–ø—É—Å–∫
loadMeta();
</script>
</body>
</html>
